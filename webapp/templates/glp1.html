<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLP-1 Analysis - Medicare Part D Intelligence</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/" class="navbar-brand">
                ðŸ’Š Medicare Part D <span>Intelligence</span>
            </a>
            <div class="navbar-views">
                <a href="/" class="nav-view-link">Main View</a>
                <a href="/glp1" class="nav-view-link active">GLP-1 Analysis</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">

        <!-- Page Header -->
        <div class="page-header">
            <h1>ðŸ’Š GLP-1 Drug Coverage Analysis</h1>
            <p>Comprehensive comparison of GLP-1 coverage across target companies: Elevance, UnitedHealth, Humana, CVS, Molina, Centene, and Alignment</p>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p>Loading GLP-1 analysis data...</p>
        </div>

        <!-- 2025 Data Container -->
        <div id="masterTableContainer2025" style="display: none;">
            <div class="table-container">
                <div class="table-header">
                    <h2>2025 Master Comparison Table</h2>
                    <p>Coverage, Tier Distribution, and Restrictions by Drug and Company</p>
                </div>
                <div class="table-wrapper">
                    <table id="masterTable2025" class="master-table">
                        <thead id="tableHead2025"></thead>
                        <tbody id="tableBody2025"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 2025 Pricing Tables -->
        <div id="pricingTables2025" style="display: none;">
            <!-- Negotiated Rates Table -->
            <div class="table-container" style="margin-top: 3rem;">
                <div class="table-header">
                    <h2>2025 Negotiated Rates (Plan's Wholesale Cost)</h2>
                    <p>Average unit cost per 30-day supply by drug and company</p>
                </div>
                <div class="table-wrapper">
                    <table id="pricingTable2025" class="master-table">
                        <thead id="pricingHead2025"></thead>
                        <tbody id="pricingBody2025"></tbody>
                    </table>
                </div>
            </div>

            <!-- Member Cost-Sharing Table -->
            <div class="table-container" style="margin-top: 3rem;">
                <div class="table-header">
                    <h2>2025 Member Cost-Sharing</h2>
                    <p>Copay ($) and Coinsurance (%) by drug and company</p>
                </div>
                <div class="table-wrapper">
                    <table id="memberCostTable2025" class="master-table">
                        <thead id="memberCostHead2025"></thead>
                        <tbody id="memberCostBody2025"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        let glp1Data2025 = [];
        let pricingData2025 = [];
        let memberCostData2025 = [];

        // Load GLP-1 data for 2025 only
        async function loadGLP1Data() {
            // Show loading
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('masterTableContainer2025').style.display = 'none';
            document.getElementById('pricingTables2025').style.display = 'none';

            try {
                // Load 2025 data
                const [master2025, pricing2025, costs2025] = await Promise.all([
                    fetch('/api/glp1/master-table?year=2025').then(r => r.ok ? r.json() : []),
                    fetch('/api/glp1/pricing?year=2025').then(r => r.ok ? r.json() : []),
                    fetch('/api/glp1/member-costs?year=2025').then(r => r.ok ? r.json() : [])
                ]);

                glp1Data2025 = Array.isArray(master2025) ? master2025 : [];
                pricingData2025 = Array.isArray(pricing2025) ? pricing2025 : [];
                memberCostData2025 = Array.isArray(costs2025) ? costs2025 : [];

                console.log('2025 Data loaded:', {
                    master: glp1Data2025.length,
                    pricing: pricingData2025.length,
                    costs: memberCostData2025.length,
                    costsSample: memberCostData2025.length > 0 ? memberCostData2025[0] : null
                });

                // Always show 2025 tables
                renderMasterTable('2025', glp1Data2025);
                document.getElementById('masterTableContainer2025').style.display = 'block';
                
                renderPricingTable('2025', pricingData2025);
                renderMemberCostTable('2025', memberCostData2025);
                document.getElementById('pricingTables2025').style.display = 'block';

                // Hide loading
                document.getElementById('loadingState').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading GLP-1 data:', error);
                document.getElementById('loadingState').innerHTML = 
                    '<p style="color: #ef4444;">Error loading data: ' + error.message + '. Please check the console for details.</p>';
            }
        }

        // Render master table - Companies as columns, Drugs as rows
        function renderMasterTable(year, glp1Data) {
            const tableHead = document.getElementById(`tableHead${year}`);
            const tableBody = document.getElementById(`tableBody${year}`);

            // Safety check
            if (!Array.isArray(glp1Data) || glp1Data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="64" style="text-align: center; padding: 2rem;">No data available</td></tr>';
                return;
            }

            // Companies are now column headers (the 7 target companies)
            const companies = ['Elevance', 'UnitedHealth', 'Humana', 'CVS', 'Molina', 'Centene', 'Alignment'];
            
            // Build header - Companies as columns
            let headerHTML = `
                <tr>
                    <th rowspan="2" class="sticky-col">Drug</th>
            `;
            
            // Add company columns (each company gets multiple sub-columns)
            companies.forEach(company => {
                headerHTML += `
                    <th colspan="9" class="company-header">${company}</th>
                `;
            });
            
            headerHTML += `</tr><tr>`;
            
            // Add sub-headers for each company
            companies.forEach(() => {
                headerHTML += `
                    <th>Formularies<br><small># / %</small></th>
                    <th>Plans<br><small># / %</small></th>
                    <th>Tier 3<br><small># / %</small></th>
                    <th>Tier 4<br><small># / %</small></th>
                    <th>Tier 5<br><small># / %</small></th>
                    <th>Tier 6<br><small># / %</small></th>
                    <th>PA<br><small># / %</small></th>
                    <th>ST<br><small># / %</small></th>
                    <th>QL<br><small># / %</small></th>
                `;
            });
            
            headerHTML += `</tr>`;
            tableHead.innerHTML = headerHTML;

            // Build body - one row per drug
            tableBody.innerHTML = '';
            
            glp1Data.forEach(drug => {
                const tr = document.createElement('tr');
                let rowHTML = `<td class="drug-name sticky-col">${drug.drug_name}</td>`;
                
                // Add data for each company
                companies.forEach(company => {
                    const companyData = drug.companies[company] || {};
                    rowHTML += `
                        <td class="coverage-cell">
                            <strong>${companyData.formularies_with_drug || 0}</strong><br>
                            <small>${(companyData.formulary_pct || 0).toFixed(1)}%</small>
                        </td>
                        <td class="coverage-cell">
                            <strong>${companyData.plans_with_drug || 0}</strong><br>
                            <small>${(companyData.plan_pct || 0).toFixed(1)}%</small>
                        </td>
                        <td class="tier-cell tier3">
                            <strong>${companyData.tier3_count || 0}</strong><br>
                            <small>${(companyData.tier3_pct || 0).toFixed(1)}%</small>
                        </td>
                        <td class="tier-cell tier4">
                            <strong>${companyData.tier4_count || 0}</strong><br>
                            <small>${(companyData.tier4_pct || 0).toFixed(1)}%</small>
                        </td>
                        <td class="tier-cell tier5">
                            <strong>${companyData.tier5_count || 0}</strong><br>
                            <small>${(companyData.tier5_pct || 0).toFixed(1)}%</small>
                        </td>
                        <td class="tier-cell tier6">
                            <strong>${companyData.tier6_count || 0}</strong><br>
                            <small>${(companyData.tier6_pct || 0).toFixed(1)}%</small>
                        </td>
                        <td class="restriction-cell">
                            <strong>${companyData.pa_count || 0}</strong><br>
                            <small>${(companyData.pa_pct || 0).toFixed(1)}%</small>
                        </td>
                        <td class="restriction-cell">
                            <strong>${companyData.st_count || 0}</strong><br>
                            <small>${(companyData.st_pct || 0).toFixed(1)}%</small>
                        </td>
                        <td class="restriction-cell">
                            <strong>${companyData.ql_count || 0}</strong><br>
                            <small>${(companyData.ql_pct || 0).toFixed(1)}%</small>
                        </td>
                    `;
                });
                
                tr.innerHTML = rowHTML;
                tableBody.appendChild(tr);
            });
        }

        // Render pricing table - Negotiated rates
        function renderPricingTable(year, pricingData) {
            const tableHead = document.getElementById(`pricingHead${year}`);
            const tableBody = document.getElementById(`pricingBody${year}`);

            if (!Array.isArray(pricingData) || pricingData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="22" style="text-align: center; padding: 2rem;">No pricing data available</td></tr>';
                return;
            }

            const companies = ['Elevance', 'UnitedHealth', 'Humana', 'CVS', 'Molina', 'Centene', 'Alignment'];
            
            // Build header
            let headerHTML = `
                <tr>
                    <th rowspan="2" class="sticky-col">Drug</th>
            `;
            
            companies.forEach(company => {
                headerHTML += `<th colspan="3" class="company-header">${company}</th>`;
            });
            
            headerHTML += `</tr><tr>`;
            
            companies.forEach(() => {
                headerHTML += `
                    <th>Avg Cost<br><small>$</small></th>
                    <th>Min Cost<br><small>$</small></th>
                    <th>Max Cost<br><small>$</small></th>
                `;
            });
            
            headerHTML += `</tr>`;
            tableHead.innerHTML = headerHTML;

            // Build body
            tableBody.innerHTML = '';
            
            pricingData.forEach(drug => {
                const tr = document.createElement('tr');
                let rowHTML = `<td class="drug-name sticky-col">${drug.drug_name}</td>`;
                
                companies.forEach(company => {
                    const companyData = drug.companies[company] || {};
                    const avg = companyData.avg_unit_cost || 0;
                    const min = companyData.min_unit_cost || 0;
                    const max = companyData.max_unit_cost || 0;
                    
                    rowHTML += `
                        <td class="pricing-cell">${avg > 0 ? '$' + avg.toFixed(2) : 'N/A'}</td>
                        <td class="pricing-cell">${min > 0 ? '$' + min.toFixed(2) : 'N/A'}</td>
                        <td class="pricing-cell">${max > 0 ? '$' + max.toFixed(2) : 'N/A'}</td>
                    `;
                });
                
                tr.innerHTML = rowHTML;
                tableBody.appendChild(tr);
            });
        }

        // Render member cost table - Copay and Coinsurance
        function renderMemberCostTable(year, memberCostData) {
            const tableHead = document.getElementById(`memberCostHead${year}`);
            const tableBody = document.getElementById(`memberCostBody${year}`);

            if (!Array.isArray(memberCostData) || memberCostData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="36" style="text-align: center; padding: 2rem;">No member cost data available</td></tr>';
                return;
            }

            const companies = ['Elevance', 'UnitedHealth', 'Humana', 'CVS', 'Molina', 'Centene', 'Alignment'];
            
            // Build header
            let headerHTML = `
                <tr>
                    <th rowspan="2" class="sticky-col">Drug</th>
            `;
            
            companies.forEach(company => {
                headerHTML += `<th colspan="5" class="company-header">${company}</th>`;
            });
            
            headerHTML += `</tr><tr>`;
            
            companies.forEach(() => {
                headerHTML += `
                    <th>Copay<br><small># / %</small></th>
                    <th>Avg Copay<br><small>$</small></th>
                    <th>Coinsurance<br><small># / %</small></th>
                    <th>Avg %<br><small>%</small></th>
                    <th>No Charge<br><small># / %</small></th>
                `;
            });
            
            headerHTML += `</tr>`;
            tableHead.innerHTML = headerHTML;

            // Build body
            tableBody.innerHTML = '';
            
            memberCostData.forEach(drug => {
                const tr = document.createElement('tr');
                let rowHTML = `<td class="drug-name sticky-col">${drug.drug_name}</td>`;
                
                companies.forEach(company => {
                    const companyData = drug.companies[company] || {};
                    
                    rowHTML += `
                        <td class="cost-cell">
                            <strong>${companyData.copay_plans || 0}</strong><br>
                            <small>${(companyData.copay_pct || 0).toFixed(1)}%</small>
                        </td>
                        <td class="cost-cell">${companyData.avg_copay > 0 ? '$' + companyData.avg_copay.toFixed(2) : 'N/A'}</td>
                        <td class="cost-cell">
                            <strong>${companyData.coinsurance_plans || 0}</strong><br>
                            <small>${(companyData.coinsurance_pct || 0).toFixed(1)}%</small>
                        </td>
                        <td class="cost-cell">${companyData.avg_coinsurance > 0 ? companyData.avg_coinsurance.toFixed(1) + '%' : 'N/A'}</td>
                        <td class="cost-cell">
                            <strong>${companyData.no_charge_plans || 0}</strong><br>
                            <small>${(companyData.no_charge_pct || 0).toFixed(1)}%</small>
                        </td>
                    `;
                });
                
                tr.innerHTML = rowHTML;
                tableBody.appendChild(tr);
            });
        }

        // Initialize - Load both 2025 and 2026 data
        loadGLP1Data();
    </script>

    <style>
        .table-container {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .table-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #3b82f6;
        }

        .table-header h2 {
            color: #1e40af;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .table-header p {
            color: #64748b;
            font-size: 0.95rem;
        }

        .table-wrapper {
            overflow-x: auto;
            max-width: 100%;
        }

        .master-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            min-width: 1200px;
        }

        .master-table thead {
            background: #1e40af;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .master-table th {
            padding: 1rem 0.75rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .master-table th.section-header {
            background: #1e3a8a;
            font-size: 0.7rem;
        }

        .master-table th.sticky-col {
            position: sticky;
            left: 0;
            background: #1e40af;
            z-index: 11;
        }

        .master-table td {
            padding: 0.875rem 0.75rem;
            text-align: center;
            border: 1px solid #e2e8f0;
            background: white;
        }

        .master-table td.sticky-col {
            position: sticky;
            left: 0;
            background: white;
            z-index: 5;
            font-weight: 600;
        }

        .master-table tbody tr:hover {
            background: #f8fafc;
        }

        .master-table tbody tr:hover td.sticky-col {
            background: #f1f5f9;
        }

        .drug-name {
            color: #1e40af;
            font-weight: 700;
            font-size: 0.95rem;
            vertical-align: middle;
        }

        .company-name {
            color: #1e293b;
            font-weight: 600;
            text-align: left;
            padding-left: 1rem;
        }

        .coverage-cell {
            font-weight: 600;
        }

        .coverage-cell strong {
            color: #2563eb;
            font-size: 1rem;
        }

        .coverage-cell small {
            color: #64748b;
            font-size: 0.75rem;
        }

        .tier-cell {
            font-weight: 500;
        }

        .tier-cell strong {
            color: #1e293b;
        }

        .tier-cell.tier3 strong {
            color: #10b981;
        }

        .tier-cell.tier4 strong {
            color: #f59e0b;
        }

        .tier-cell.tier5 strong,
        .tier-cell.tier6 strong {
            color: #ef4444;
        }

        .restriction-cell {
            font-weight: 500;
        }

        .restriction-cell strong {
            color: #dc2626;
        }

        .restriction-cell small {
            color: #64748b;
        }

        @media (max-width: 1400px) {
            .table-wrapper {
                overflow-x: scroll;
            }
        }
    </style>
</body>
</html>


